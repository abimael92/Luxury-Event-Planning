#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Only run on main branch
if [ "$(git branch --show-current)" != "main" ]; then
  echo "Not on main branch, skipping version bump"
  exit 0
fi

# Get current version from package.json
current_version=$(node -p "require('./package.json').version")
echo "Current version: $current_version"

# Split version into parts
major=$(echo $current_version | cut -d. -f1)
minor=$(echo $current_version | cut -d. -f2)
patch=$(echo $current_version | cut -d. -f3)

# Check if patch is 99 or higher
if [ $patch -ge 99 ]; then
  # Rollover: 1.2.99 -> 1.3.0
  new_minor=$((minor + 1))
  new_patch=0
  new_version="$major.$new_minor.$new_patch"
else
  # Normal increment: 1.2.1 -> 1.2.2
  new_patch=$((patch + 1))
  new_version="$major.$minor.$new_patch"
fi

# Update package.json
node -e "const fs=require('fs');const pkg=JSON.parse(fs.readFileSync('package.json'));pkg.version='$new_version';fs.writeFileSync('package.json',JSON.stringify(pkg,null,2))"

echo "New version: $new_version"

# Git operations
git add package.json
git commit -m "version: $new_version" --no-verify